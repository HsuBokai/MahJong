<!DOCTYPE html>
<html>
<head>
<title>MahJong</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<style type="text/css">
body{ 
	margin:0px 0px 0px 0px;
	//text-align: center;
	//background-color: "black";
	//font-family: "微軟正黑體", "Microsoft JhengHei", "新細明體", "PMingLiU", "細明體", "MingLiU", "標楷體", "DFKai-sb", serif;
	//color: #000000;
	//font-size: 15px;
	//line-height:150%;
	//word-wrap: break-word;
}
</style>
</head>
<body> 
<canvas id="canvas" style="background-color:black;">
This text is displayed if your browser does not support HTML5 Canvas.
</canvas>
<script>

var Board = {
	createNew: function(context){
		var board = {};
		var tileSize = 30;
		var winds = ["A","B","C","D"];
		var dragons = ["X","Y","Z"];
		var width = 600;
		var height = 500;
		var centerX = 0;
		var centerY = 0;
		function drawTile(tile,x,y){
			context.rect(x,y,tileSize,tileSize);
			context.strokeStyle = "black";
			context.stroke();
			
			var text;
			switch(tile[0]){
				case "winds": text = winds[ tile[1] ]; break;
				case "dragons": text = dragons[ tile[1] ]; break;
				case "bamboos": text = (tile[1] + 1) + 10; break;
				case "stones": text = (tile[1] + 1) + 20; break;
				case "characters": text = (tile[1] + 1) + 30; break;
				default: console.log("drawTile error!");
			}
			context.fillStyle = "black";
			context.font = "18pt Arial";
			context.fillText(text,x+3,y+tileSize-3);
		}
		function drawRect(x,y,w,h){
			context.fillStyle = "green";
			context.fillRect(x,y,w,h);
		}
		function drawPlayer(tiles, turn){
			var len = tileSize*16;
			switch(turn){
				case 0:
					var left_ = 60;
					var top_ = height-50;
					drawRect(left_ ,top_ , len, tileSize);
					for(var i=0; i<16; ++i) drawTile(tiles[0][i], i*tileSize + left_, top_);
					break;
				case 1:
					var left_ = width-50;
					var top_ = 10;
					drawRect(left_ ,top_ , tileSize, len);
					for(var i=0; i<16; ++i) drawTile(tiles[1][i], left_, i*tileSize + top_);
					break;
				case 2:
					var left_ = 60;
					var top_ = 20;
					drawRect(left_ ,top_ , len, tileSize);
					for(var i=0; i<16; ++i) drawTile(tiles[2][i], i*tileSize + left_, top_);
					break;
				case 3:
					var left_ = 20;
					var top_ = 10;
					drawRect(left_ ,top_ , tileSize, len);
					for(var i=0; i<16; ++i) drawTile(tiles[3][i], left_, i*tileSize + top_);
					break;
			}
		}
		board.init = function(state){
			drawRect(0,0,width,height);
			var tiles = state.getTiles();
			drawPlayer(tiles,0);
			drawPlayer(tiles,1);
			drawPlayer(tiles,2);
			drawPlayer(tiles,3);
		}
		board.pickUp = function(tile, turn){
			switch(turn){
				case 0: drawTile(tile, 300, 400); break;
				case 1: drawTile(tile, 500, 250); break;
				case 2: drawTile(tile, 300, 100); break;
				case 3: drawTile(tile, 100, 250); break;
				default: console.log("board.pickUp error");
			}
		}
		board.discard = function(tile, turn, state){
			drawTile(tile, 150 + centerX * tileSize, 150 + centerY * tileSize);
			++centerX;
			if(centerX==10){
				centerX = 0;
				++centerY;
			}
			var size = tileSize;
			switch(turn){
				case 0: drawRect(300, 400, size, size); break;
				case 1: drawRect(500, 250, size, size); break;
				case 2: drawRect(300, 100, size, size); break;
				case 3: drawRect(100, 250, size, size); break;
				default: console.log("board.discard error");
			}
			var tiles = state.getTiles();
			drawPlayer(tiles,turn);
		}
		board.isInBoard = function(xx,yy){
			return 0<=xx && xx<width && 0<=yy && yy<height;
		}
		return board;
	}
}


var State = {
	createNew: function(){
		var state = {};
		function array1d(len1){
			var row = [];
			for(var j=0;j<len1;++j) row.push(-1);
			return row;
		}
		function array2d(len1, len2){
			var row = array1d(len2);
			var table = [];
			for(var i=0;i<len1;++i) table.push(row.slice());
			return table;
		}
		var bamboos = array2d(9, 4);
		var stones = array2d(9, 4);
		var characters = array2d(9, 4);
		var winds = array2d(4,4);
		var dragons = array2d(3,4);
		var wallNum = 136;
		state.init = function(){
			//for(var i=0; i<16; ++i) state.pickUp(0);
			bamboos[0][0]=0;
			bamboos[0][1]=0;
			bamboos[0][2]=0;

			bamboos[5][0]=0;
			bamboos[4][1]=0;
			bamboos[3][2]=0;

			bamboos[3][0]=0;
			bamboos[3][3]=0;
			//bamboos[2][2]=0;

			bamboos[4][0]=0;
			bamboos[3][1]=0;
			bamboos[5][2]=0;

			winds[0][0]=0;
			winds[0][1]=0;
			winds[0][2]=0;

			dragons[0][0]=0;
			dragons[0][1]=0;
			wallNum-=16;
			for(var i=0; i<16; ++i) state.pickUp(1);
			for(var i=0; i<16; ++i) state.pickUp(2);
			for(var i=0; i<16; ++i) state.pickUp(3);
		}
		function traversal(func){
			for(var i in bamboos){
				for(var j in bamboos[i]){
					if(func(bamboos,i,j,"bamboos")===true) return;
				}
			}
			for(var i in stones){
				for(var j in stones[i]){
					if(func(stones,i,j,"stones")===true) return;
				}
			}
			for(var i in characters){
				for(var j in characters[i]){
					if(func(characters,i,j,"characters")===true) return;
				}
			}
			for(var i in winds){
				for(var j in winds[i]){
					if(func(winds,i,j,"winds")===true) return;
				}
			}
			for(var i in dragons){
				for(var j in dragons[i]){
					if(func(dragons,i,j,"dragons")===true) return;
				}
			}
		}
		state.getTiles = function(){
			var tiles = [[],[],[],[]];
			traversal(function(tileStateArray,i,j,type){
				var tileState = tileStateArray[i][j];
				if(0 <= tileState && tileState < 4) tiles[tileState].push([type, parseInt(i), parseInt(j)]);
			});
			return tiles;
		}
		state.pickUp = function(turn){
			/*if(turn===0) {
				dragons[0][3]=0;
				return ["dragons",0,3];
			}*/
			var num = Math.floor(Math.random() * (wallNum));
			var finalTile;
			traversal(function(tileStateArray, i, j, type){
				if(tileStateArray[i][j]==-1){
					if(num==0) {
						finalTile = [type, parseInt(i), parseInt(j)];
						tileStateArray[i][j] = turn;
						--wallNum;
						return true;
					}
					--num;
				}
			});
			return finalTile;
		}
		state.isWin = function(turn){
			var tiles = state.getTiles();
			return state.isHu(tiles[turn]);
		}
		state.isHu = function(myTiles) {
			function isTheSame(tile1, tile2){
				return tile1[0]===tile2[0] && tile1[1]===tile2[1];
			}
			function getTypeSplit(eye1, eye2){
				var initArr = [0,0,0,0,0,0,0,0,0]
				var typeSplit = [[0,0,0,0],[0,0,0]];
				typeSplit.push(initArr.slice());
				typeSplit.push(initArr.slice());
				typeSplit.push(initArr.slice());
				for(var j=0; j<17; ++j){
					if(j!=eye1 && j!=eye2){
						var type = myTiles[j][0];
						var value = myTiles[j][1];
						switch(type){
							case "winds": typeSplit[0][value]++; break;
							case "dragons": typeSplit[1][value]++; break;
							case "bamboos": typeSplit[2][value]++; break;
							case "stones": typeSplit[3][value]++; break;
							case "characters": typeSplit[4][value]++; break;
							default: console.log("getTypeSplit error!!");
						}
					}
				}
				return typeSplit;
			}
			function is_winds_dragons_ok(valueArr){
				var len = valueArr.length;
				for(var i=0; i<len; ++i) if(valueArr[i]%3 != 0) return false;
				return true;
			}
			function is_123456789_ok(valueArr){
				var len = valueArr.length;
				var k;
				var sum = 0;
				for(var i=0; i<len; ++i) {
					var v = valueArr[i];
					if(v<0) return false;
					if(v!=0) k=i;
					sum += v;
				}
				if(sum == 0) return true;
				if(sum % 3 != 0) return false;
				if(valueArr[k] >= 3) {
					valueArr[k]-=3;
					var check = is_123456789_ok(valueArr);
					valueArr[k]+=3;
					if(check===true) return true;
				}
				if(k<=6){ //0~6
					valueArr[k]	-=1;
					valueArr[k+1]	-=1;
					valueArr[k+2]	-=1;
					var check = is_123456789_ok(valueArr);
					valueArr[k]	+=1;
					valueArr[k+1]	+=1;
					valueArr[k+2]	+=1;
					if(check===true) return true;
				}
				if(2<=k){ // 2~8
					valueArr[k]	-=1;
					valueArr[k-1]	-=1;
					valueArr[k-2]	-=1;
					var check = is_123456789_ok(valueArr);
					valueArr[k]	+=1;
					valueArr[k-1]	+=1;
					valueArr[k-2]	+=1;
					if(check===true) return true;
				}
				if(1<=k && k<=7){ // 1~7
					valueArr[k-1]	-=1;
					valueArr[k]	-=1;
					valueArr[k+1]	-=1;
					var check = is_123456789_ok(valueArr);
					valueArr[k-1]	+=1;
					valueArr[k]	+=1;
					valueArr[k+1]	+=1;
					if(check===true) return true;
				}
				return false;
			}
			for(var i=1; i<17; ++i) {
				if(isTheSame(myTiles[i-1], myTiles[i])) {
					var typeSplit = getTypeSplit(i-1,i);
					if( is_winds_dragons_ok(typeSplit[0])===true &&
					is_winds_dragons_ok(typeSplit[1])===true &&
					is_123456789_ok(typeSplit[2])===true &&
					is_123456789_ok(typeSplit[3])===true &&
					is_123456789_ok(typeSplit[4])===true) return true;
				}
			}
			return false;
		}
		state.isEndWallNum = function(){ return wallNum <= 8; }
		state.takeAction = function(tile){
			var type = tile[0];
			var i=tile[1];
			var j=tile[2];
			switch(type){
				case "winds": winds[i][j]=-2; break;
				case "dragons": dragons[i][j]=-2; break;
				case "bamboos": bamboos[i][j]=-2; break;
				case "stones": stones[i][j]=-2; break;
				case "characters": characters[i][j]=-2; break;
				default: console.log("state.takeAction error!");
			}
		}
		state.getScore = function(tile, turn){
			function countScore(tileStateArray,i,j){
				var score = 0;
				for(var jj=0; jj<4; ++jj) {
					if(jj!=j) if(tileStateArray[i][jj]===turn) score += 5;
				}
				if(tileStateArray.length < 9) return score;
				if(1<=i){
					var addScore = 0;
					for(var jj=0; jj<4; ++jj) {
						if(tileStateArray[i-1][jj]===turn) addScore = 3;
					}
					score += addScore;
				}
				if(i<=7){
					var addScore = 0;
					for(var jj=0; jj<4; ++jj) {
						if(tileStateArray[i+1][jj]===turn) addScore = 3;
					}
					score += addScore;
				}
				return score;
			}
			var type = tile[0];
			var i=tile[1];
			var j=tile[2];
			var score = 0;
			switch(type){
				case "winds": score = countScore(winds,i,j); break;
				case "dragons": score = countScore(dragons,i,j); break;
				case "bamboos": score = countScore(bamboos,i,j); break;
				case "stones": score = countScore(stones,i,j); break;
				case "characters": score = countScore(characters,i,j); break;
				default: console.log("state.getScore error!");
			}
			return score;
		}
		return state;
	}
}

var Game = {
	createNew: function(agent0, agent1, agent2, agent3){
		var game = {};
		var turn = 0;
		var duration = 100;
		var nextStep;
		var isPause = false;
		var canvas = document.getElementById("canvas");
		var board = Board.createNew(canvas.getContext("2d"))
		var state = State.createNew();
		var agents = [agent0.createNew(state, 0), agent1.createNew(state, 1), agent2.createNew(state, 2), agent3.createNew(state, 3)];
		game.init = function(){
			canvas.width = window.innerWidth;
			canvas.height = window.innerHeight;
			state.init();
			board.init(state);
		}
		game.takeTurn = function(){
			turn = (turn+1)%4;
		}
		function pickUp() {
			//console.log("pickup");
			board.pickUp(state.pickUp(turn), turn);
			var isSelfWin = state.isWin( turn );
			if(isSelfWin || state.isEndWallNum()){
				var text;
				if(isSelfWin) text = turn + " wins!!";
				else text = "no one wins!!";
				window.alert(text);
			}
			else{
				nextStep = discard;
				if(isPause==false) setTimeout(nextStep, duration);
			}
		}
		function discard() {
			//console.log("discard");
			var agent = agents[turn];
			if(agent.isManual()) return;
			else tile = agent.getAction();
			//console.log(tile);
			//if(state.isActionLegal(tile) == false) return;
			state.takeAction(tile, turn);
			board.discard(tile, turn, state);
			game.takeTurn();
			nextStep = pickUp;
			if(isPause==false) setTimeout(nextStep, duration);
		}
		game.start = function(){
			canvas.addEventListener("mousedown", function(event){
				isPause = (isPause) ? false : true;
				if(isPause==false) setTimeout(nextStep, duration);
			}, false);
			nextStep = pickUp;
			if(isPause==false) setTimeout(nextStep, duration);
		}
		return game;
	}
}

var ManualAgent = {
	createNew: function(state, myTurn){
		var agent = {};
		agent.isManual = function(){ return true;}
		agent.getName = function(){ return "manual";}
		return agent;
	}
}


var ReflexAgent = {
	createNew: function(state, myTurn){
		var agent = {};
		agent.getAction = function(){
			var tiles = state.getTiles();
			var myTiles = tiles[myTurn];
			var minScore = 9999;
			var i=17;
			while(i--){
			//for(var i=0; i<17; ++i) { 
				var tile = myTiles[i];
				var s = state.getScore(tile, myTurn);
				console.log(tile,s);
				if(s < minScore){
					minScore = s;
					finalTileIndex = i;
				}
			}
			return myTiles[finalTileIndex];
		}
		agent.isManual = function(){ return false;}
		agent.getName = function(){ return "reflex";}
		return agent;
	}
}


game = Game.createNew(agent0 = ReflexAgent, agent1 = ReflexAgent, agent2 = ReflexAgent, agent3 = ReflexAgent);
game.init();
game.start();

		</script>
</body>
</html>
